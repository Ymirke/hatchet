
RulesVersion: 2

Samplers:
  __default__:
    RulesBasedSampler:
      Rules:
        #Rule 1
        - Name: Keep 500 status codes
          SampleRate: 1
          Conditions:
            - Fields:
                - http.status_code
                - http.response.status_code
              Operator: '>='
              Value: 500
              Datatype: int
        #Rule 2
        - Name: Keep where error field exists
          SampleRate: 1
          Conditions:
            - Field: error
              Operator: exists
        #Rule 3
        - Name: drop healthchecks
          Drop: true
          Scope: span
          Conditions:
            - Field: root.http.route
              Operator: starts-with
              Value: /healthz
            - Fields:
                - http.status_code
                - http.response.status_code
              Operator: "="
              Value: 200
              Datatype: int
        #Rule 4
        - Name: Keep long duration traces
          SampleRate: 1
          Scope: span
          Conditions:
            - Field: trace.parent_id
              Operator: not-exists
            - Field: duration_ms
              Operator: ">="
              Value: 5000
              Datatype: int
        #Rule 5
        - Name: Dynamically Sample 200s through 400s
          Conditions:
            - Fields:
                - http.status_code
                - http.response.status_code
              Operator: ">="
              Value: 200
              Datatype: int
          Sampler:
            EMADynamicSampler:
              GoalSampleRate: 1000              # This is a sample rate itself
              FieldList:
                - service.name
                - root.http.route
                - http.method
        #Rule 6
        - Name: Dynamically Sample Non-HTTP Request
          Conditions:
            - Field: status_code
              Operator: "<"
              Value: 2
              Datatype: int
          Sampler:
            EMADynamicSampler:
              GoalSampleRate: 1000              # This is a sample rate itself
              FieldList:
                - service.name
                - grpc.method
                - grpc.service
        #Rule 7
        - Name: Catchall rule
          Sampler:
            EMAThroughputSampler:
              GoalThroughputPerSec: 37
              UseClusterSize: true # Ensures GoalThroughputPerSec is for the full refinery cluster and not per node
              FieldList:
                - service.name
